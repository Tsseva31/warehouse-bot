/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –î–≤–∏–∂–µ–Ω–∏—è
 * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ Operation_ID –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–∞–º–∫–∏
 */
function formatMovements() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("–î–≤–∏–∂–µ–Ω–∏—è");
  if (!sheet) {
    SpreadsheetApp.getUi().alert("–õ–∏—Å—Ç '–î–≤–∏–∂–µ–Ω–∏—è' –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    return;
  }
  
  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();
  
  if (lastRow <= 1) {
    SpreadsheetApp.getUi().alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
    return;
  }
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
  const dataRange = sheet.getRange(2, 1, lastRow - 1, lastCol);
  dataRange.setBorder(false, false, false, false, false, false);
  dataRange.setBackground(null);
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  const data = sheet.getRange(2, 1, lastRow - 1, lastCol).getValues();
  
  // –ù–∞—Ö–æ–¥–∏–º –∫–æ–ª–æ–Ω–∫—É Operation_ID (E = –∏–Ω–¥–µ–∫—Å 4)
  const opIdCol = 4; // E column (0-indexed)
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –ø–æ Operation_ID
  let currentOpId = null;
  let groupStart = 2; // –ù–∞—á–∏–Ω–∞–µ–º —Å–æ 2-–π —Å—Ç—Ä–æ–∫–∏ (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
  let colorIndex = 0;
  
  // –¶–≤–µ—Ç–∞ –¥–ª—è —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø
  const colors = [
    "#FFFFFF", // –ë–µ–ª—ã–π
    "#F8F9FA", // –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π
  ];
  
  // –¶–≤–µ—Ç —Ä–∞–º–∫–∏
  const borderColor = "#E0E0E0";
  
  for (let i = 0; i < data.length; i++) {
    const rowNum = i + 2; // –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
    const opId = data[i][opIdCol];
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    if (!opId || opId === "") {
      continue;
    }
    
    if (currentOpId === null) {
      currentOpId = opId;
      groupStart = rowNum;
    } else if (opId !== currentOpId) {
      // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≥—Ä—É–ø–ø—É - –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–º–∫—É
      formatGroup(sheet, groupStart, rowNum - 1, lastCol, colors[colorIndex % 2]);
      colorIndex++;
      
      // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
      currentOpId = opId;
      groupStart = rowNum;
    }
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≥—Ä—É–ø–ø—É
  if (currentOpId !== null) {
    formatGroup(sheet, groupStart, lastRow, lastCol, colors[colorIndex % 2]);
  }
  
  SpreadsheetApp.getUi().alert("‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!");
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≥—Ä—É–ø–ø—É —Å—Ç—Ä–æ–∫ - –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–∞–º–∫—É –∏ —Ñ–æ–Ω
 */
function formatGroup(sheet, startRow, endRow, lastCol, bgColor) {
  const range = sheet.getRange(startRow, 1, endRow - startRow + 1, lastCol);
  
  // –§–æ–Ω
  range.setBackground(bgColor);
  
  // –¢–æ–ª—Å—Ç–∞—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –≥—Ä—É–ø–ø—ã
  range.setBorder(
    true, true, true, true,  // top, left, bottom, right
    false, false,            // vertical, horizontal (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ)
    "#4A4A4A",              // —Ü–≤–µ—Ç
    SpreadsheetApp.BorderStyle.SOLID_MEDIUM
  );
}

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç –º–µ–Ω—é –≤ —Ç–∞–±–ª–∏—Ü—É
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu("üîß –°–∫–ª–∞–¥")
    .addItem("üìä –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É", "formatMovements")
    .addItem("üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", "clearFormatting")
    .addToUi();
}

/**
 * –û—á–∏—â–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
 */
function clearFormatting() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("–î–≤–∏–∂–µ–Ω–∏—è");
  if (!sheet) return;
  
  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();
  
  if (lastRow <= 1) return;
  
  const dataRange = sheet.getRange(2, 1, lastRow - 1, lastCol);
  dataRange.setBorder(false, false, false, false, false, false);
  dataRange.setBackground(null);
  
  SpreadsheetApp.getUi().alert("‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ");
}